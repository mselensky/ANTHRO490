# Results

##Filtered, Silva-based results <br>
###Alpha diversity
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE, include=FALSE}
# Matt Selensky
# ANTHRO 490 Final Project
# Shannon Group Significance for Silva (Filtered) Outputs

library(ggplot2)
library(ggpubr)
library(plotly)

rm(list=ls())

setwd("C:/Users/msele/OneDrive/Documents/Winter2019_Classes/ANTHRO_490/Final_Project/core_metrics_filtered")

Alpha_div <- read.delim("shannon_group_significance.tsv", sep="\t", header = TRUE, row.names = 1, check.names = FALSE)

#--------By Class

t <- compare_means(shannon ~ Class, data = Alpha_div, method = "t.test")
class_comparison <- list(c("Soil", "Tan"), c("Soil", "White"), c("Soil","Yellow"), c("Tan","White"), c("Tan", "Yellow"), c("White", "Yellow"))

mat_color <- ggplot(Alpha_div, aes(Class, shannon, label="", group = Mat_color, text = paste("Cave: ", Cave))) +
       geom_point() +
       geom_boxplot() +
       #stat_pvalue_manual(class_comparisons, label = "p.adj", y.position = c(9,8.5,8)) +
       stat_compare_means(comparisons = class_comparison, label = ".p.format.") +
      # stat_compare_means(label = "p.signif", method = "kruskal.test", ref.group = "Soil") +
       ggtitle("Alpha diversity by mat type or surface soil (Silva, Filtered)") 

#---------By Type

t <- compare_means(shannon ~ Class, data = Alpha_div, method = "t.test")
class_comparison <- list(c("Cave", "Soil"))

type <- ggplot(Alpha_div, aes(Type, shannon, label="", color = Type, group = Type, text = paste("Cave: ", Cave))) +
  theme(legend.position = "none") +
  geom_point() +
  geom_boxplot() +
  stat_compare_means(comparisons = class_comparison, label = ".p.adj.") +
  ggtitle("Alpha diversity of caves vs surface soil (Silva, Filtered)") 

type

#---------Remove soil samples for alpha diversity comparison among mat types
Alpha_div_caves <- subset(Alpha_div, Type == "Cave")
t <- compare_means(shannon ~ Class, data = Alpha_div_caves, method = "t.test")
class_comparison <- list(c("Tan","White"), c("Tan", "Yellow"), c("White", "Yellow"))

caves_only <- ggplot(Alpha_div_caves, aes(Class, shannon, label="", group = Class, text = paste("Cave: ", Cave))) +
  theme(legend.position = "none") +
  geom_point() +
  geom_boxplot() +
  stat_compare_means(comparisons = class_comparison, label = "p.adj.") +
  ggtitle("Alpha diversity between cave mat types (Silva, Filtered)") 

caves_only
```
<br>
Alpha diversity comparison between cave and surface soil samples:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
type
```
<br>
Alpha diversity comparison between surface soil samples and mat types:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
mat_color
```
<br>

###Beta diversity
####Phylum-level
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE, include=FALSE}
# ANTHRO 490 final project - NMDS plots
# Silva with Filtering
# Winter 2019

library(ggplot2)
library(vegan)
library(funrar)
library(plotly)

rm(list=ls())

getwd()

setwd("C:/Users/msele/OneDrive/Documents/Winter2019_Classes/ANTHRO_490/Final_Project/taxonomy")

L2 <- read.delim("feature-table_with_taxa_L2.txt", sep="\t", header = TRUE, row.names = 1, check.names = FALSE)
L2_metadata <- read.csv("LABEmetadata_all_samples.txt", check.names = FALSE, fileEncoding = "UTF-8-BOM")

is.data.frame(L2)
L2_transposed <- t(L2)

# Convert L5 (an absolute abundance table) into relative abundance table
mat = as.matrix(L2_transposed)
head(mat)  # Has absolute abundances
rel_mat = make_relative(mat)
head(rel_mat)  # Relative abundances

# Make_relative causes rel_mat to be atomic, not recursive. downstream data.frame only works on recursive objects 
is.recursive(rel_mat)
is.atomic(rel_mat)
rel_mat_recursive <- as.data.frame(rel_mat)
is.recursive(rel_mat_recursive)

#
grouping_info <- data.frame(row.names = rownames(rel_mat), t(as.data.frame(strsplit(rownames(rel_mat),"\t"))))
head(grouping_info)


NMDS_L2 <- metaMDS(rel_mat_recursive, distance = "bray", k = 2, try = 20, trymax = 100)
stressplot(NMDS_L2, pch = 19, cex=0.75, l.col = "tomato", p.col = "skyblue")

info_L2 = data.frame(x=NMDS_L2$point[,2],y=NMDS_L2$point[,1],SampleID = as.factor(grouping_info[,1]))

# Merge metadata file with info_L5, which contains NMDS coordinates
L2_merged <- merge(info_L2, L2_metadata, by.x = "SampleID", by.y = "SampleID")
```

```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
p <- ggplot(L2_merged, aes(x, y, label="", color = Type, group = Type, text = paste("Cave: ", Cave))) +
  geom_point() +
  scale_shape_manual(values=c(1:17)) +
  geom_text() +
  ggtitle("NMDS of Phylum-Level Taxonomy using Silva with Filtering") +
  theme(panel.background = element_rect("white")) +
  stat_ellipse(geom = "path")

p <- ggplotly(p)

p
```


####Family-level
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE, include=FALSE}
library(ggplot2)
library(vegan)
library(funrar)
library(plotly)
#package_version('plotly')

rm(list=ls())

getwd()

setwd("C:/Users/msele/OneDrive/Documents/Winter2019_Classes/ANTHRO_490/Final_Project/taxonomy")

L5 <- read.delim("feature-table_with_taxa_L5.txt", sep="\t", header = TRUE, row.names = 1, check.names = FALSE)
L5_metadata <- read.csv("LABEmetadata_all_samples.txt", check.names = FALSE, fileEncoding = "UTF-8-BOM")

is.data.frame(L5)
L5_transposed <- t(L5)

# Convert L5 (an absolute abundance table) into relative abundance table
mat = as.matrix(L5_transposed)
rel_mat = make_relative(mat)

# Make_relative causes rel_mat to be atomic, not recursive. downstream data.frame only works on recursive objects 
is.recursive(rel_mat)
is.atomic(rel_mat)
rel_mat_recursive <- as.data.frame(rel_mat)
is.recursive(rel_mat_recursive)

grouping_info <- data.frame(row.names = rownames(rel_mat), t(as.data.frame(strsplit(rownames(rel_mat),"\t"))))
head(grouping_info)

NMDS_L5 <- metaMDS(rel_mat_recursive, distance = "bray", k = 2, try = 20, trymax = 100)
stressplot(NMDS_L5, pch = 19, cex=0.75, l.col = "tomato", p.col = "skyblue")

info_L5 = data.frame(x=NMDS_L5$point[,2],y=NMDS_L5$point[,1],SampleID = as.factor(grouping_info[,1]))

# Merge metadata file with info_L5, which contains NMDS coordinates
L5_merged <- merge(info_L5, L5_metadata, by.x = "SampleID", by.y = "SampleID")

```

<br>
NMDS of cave vs surface soil:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
# Plot NMDS
p <- ggplot(L5_merged, aes(x, y, label="", color = Type, group = Type, text = paste("Cave: ", Cave))) +
  geom_point() +
 # scale_shape_manual(values=c(1:17)) +
  scale_color_manual(values=c("skyblue", "tomato", "skyblue", "tomato")) +
  geom_text() +
  ggtitle("Family-level NMDS using Silva (with Filtering)") +
  theme(panel.background = element_rect("white")) +
  stat_ellipse(geom = "path")



p <- ggplotly(p)


p
```
<br>
Family-level NMDS plot:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
# Plot NMDS
p <- ggplot(L5_merged, aes(x, y, label="", color = Class, group = Mat_color, text = paste("Cave: ", Cave))) +
  geom_point() +
 # scale_shape_manual(values=c(1:17)) +
  scale_color_manual(values=c("darkgoldenrod4", "tan", "grey88", "gold")) +
  geom_text() +
  ggtitle("Family-level NMDS using Silva (with Filtering)") +
  theme(panel.background = element_rect("white"))
 # stat_ellipse(geom = "path")



p <- ggplotly(p)


p
```
<br>
NMDS plot with ellipses indicating 95% confidence level at which ellipses were drawn:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
# Plot NMDS
p <- ggplot(L5_merged, aes(x, y, label="", color = Class, group = Mat_color, text = paste("Cave: ", Cave))) +
  geom_point() +
 # scale_shape_manual(values=c(1:17)) +
  scale_color_manual(values=c("darkgoldenrod4", "tan", "grey88", "gold")) +
  geom_text() +
  ggtitle("Family-level NMDS using Silva (with Filtering)") +
  theme(panel.background = element_rect("white")) +
  stat_ellipse(geom = "path")

p <- ggplotly(p)

p
```

##Unfiltered, Silva-based results
###Alpha diversity

```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE, include=FALSE}
# Matt Selensky
# ANTHRO 490 Final Project
# Shannon Group Significance for Silva (Unfiltered) Outputs

library(ggplot2)
library(ggpubr)
library(plotly)

rm(list=ls())

setwd("C:/Users/msele/OneDrive/Documents/Winter2019_Classes/ANTHRO_490/Final_Project/core_metrics_unfiltered")

Alpha_div <- read.delim("shannon_group_signif_silva_unfiltered.tsv", sep="\t", header = TRUE, row.names = 1, check.names = FALSE)

#--------By Class

t <- compare_means(shannon ~ Class, data = Alpha_div, method = "t.test")
class_comparison <- list(c("Soil", "Tan"), c("Soil", "White"), c("Soil","Yellow"), c("Tan","White"), c("Tan", "Yellow"), c("White", "Yellow"))

mat_color <- ggplot(Alpha_div, aes(Class, shannon, label="", group = Mat_color, text = paste("Cave: ", Cave))) +
  geom_point() +
  geom_boxplot() +
  #stat_pvalue_manual(class_comparisons, label = "p.adj", y.position = c(9,8.5,8)) +
  stat_compare_means(comparisons = class_comparison, label = ".p.adj.") +
  ggtitle("Alpha diversity by mat type or surface soil (Silva, Unfiltered)") 

mat_color

ggplotly(mat_color)

#---------By Type

t <- compare_means(shannon ~ Class, data = Alpha_div, method = "t.test")
class_comparison <- list(c("Cave", "Soil"))

type <- ggplot(Alpha_div, aes(Type, shannon, label="", color = Type, group = Type, text = paste("Cave: ", Cave))) +
  theme(legend.position = "none") +
  geom_point() +
  geom_boxplot() +
  stat_compare_means(comparisons = class_comparison, label = ".p.adj.") +
  ggtitle("Alpha diversity of caves vs surface soil (Silva, Unfiltered)") 

type



#---------Remove soil samples for alpha diversity comparison among mat types
Alpha_div_caves <- subset(Alpha_div, Type == "Cave")
t <- compare_means(shannon ~ Class, data = Alpha_div_caves, method = "t.test")
class_comparison <- list(c("Tan","White"), c("Tan", "Yellow"), c("White", "Yellow"))

caves_only <- ggplot(Alpha_div_caves, aes(Class, shannon, label="", color = Class, group = Class, text = paste("Cave: ", Cave))) +
  theme(legend.position = "none") +
  geom_point() +
  geom_boxplot() +
  stat_compare_means(comparisons = class_comparison, label = ".p.adj.") +
  # stat_compare_means(label = "p.signif") +
  ggtitle("Alpha diversity between cave mat types (Silva, Unfiltered)") 

caves_only

```
<br>
Alpha diversity comparison between cave and surface soil samples:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
type
```
<br>
Alpha diversity comparison between surface soil samples and mat types:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
mat_color
```
<br>

###Beta Diversity
####Phylum-level

```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE, include=FALSE}
library(ggplot2)
library(vegan)
library(funrar)
library(plotly)

rm(list=ls())

getwd()

setwd("C:/Users/msele/OneDrive/Documents/Winter2019_Classes/ANTHRO_490/Final_Project/core_metrics_unfiltered")

L2 <- read.csv("level_2_unfiltered.csv", header = TRUE, row.names = 1, check.names = FALSE)
L2_metadata <- read.csv("LABEmetadata_all_samples.txt", check.names = FALSE, fileEncoding = "UTF-8-BOM")

L2_abun <- L2[,c(-43:-55)]

is.data.frame(L2_abun)
L2_transposed <- t(L2_abun)

# Convert L2 (an absolute abundance table) into relative abundance table
mat = as.matrix(L2_transposed)
head(mat)  # Has absolute abundances
rel_mat = make_relative(mat)
head(rel_mat)  # Relative abundances

# Make_relative causes rel_mat to be atomic, not recursive. downstream data.frame only works on recursive objects 
is.recursive(rel_mat)
is.atomic(rel_mat)
rel_mat_recursive <- as.data.frame(rel_mat)
is.recursive(rel_mat_recursive)

rel_mat_recursive_t <- t(rel_mat_recursive)
is.recursive(rel_mat_recursive_t)
rel_mat_recursive_t <- as.data.frame(rel_mat_recursive_t)

#
grouping_info <- data.frame(row.names = rownames(rel_mat_recursive_t), t(as.data.frame(strsplit(rownames(rel_mat_recursive_t),"\t"))))
head(grouping_info)

NMDS_L2 <- metaMDS(rel_mat_recursive_t, distance = "bray", k = 2, try = 20, trymax = 100)
stressplot(NMDS_L2, pch = 19, cex=0.75, l.col = "tomato", p.col = "skyblue")

info_L2 = data.frame(x=NMDS_L2$point[,2],y=NMDS_L2$point[,1],SampleID = as.factor(grouping_info[,1]))

# Merge metadata file with info_L5, which contains NMDS coordinates
L2_merged <- merge(info_L2, L2_metadata, by.x = "SampleID", by.y = "SampleID")
```
<br>
Phylum-level taxonomy NMDS clustering using Silva without filtering:
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
# Plot NMDS
p <- ggplot(L2_merged, aes(x, y, label="", color = Type, group = Type, text = paste("Cave: ", Cave))) +
  geom_point() +
  scale_shape_manual(values=c(1:17)) +
  geom_text() +
  ggtitle("NMDS of Phylum-Level Taxonomy using Silva without Filtering") +
  theme(panel.background = element_rect(fill = "white")) +
  stat_ellipse(geom = "path")

p <- ggplotly(p)

p
```
<br>
####Family-level
```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE, include=FALSE}
# ANTHRO 490 final project - NMDS plots
# Silva without Filtering
# Winter 2019

library(ggplot2)
library(vegan)
library(funrar)
library(plotly)

rm(list=ls())

getwd()

setwd("C:/Users/msele/OneDrive/Documents/Winter2019_Classes/ANTHRO_490/Final_Project/core_metrics_unfiltered")

L5 <- read.csv("level_5_unfiltered.csv", header = TRUE, row.names = 1, check.names = FALSE)
L5_metadata <- read.csv("LABEmetadata_all_samples.txt", check.names = FALSE, fileEncoding = "UTF-8-BOM")

L5_abun <- L5[,c(-726:-738)]

is.data.frame(L5_abun)
L5_transposed <- t(L5_abun)

# Convert L2 (an absolute abundance table) into relative abundance table
mat = as.matrix(L5_transposed)
head(mat)  # Has absolute abundances
rel_mat = make_relative(mat)
head(rel_mat)  # Relative abundances

# Make_relative causes rel_mat to be atomic, not recursive. downstream data.frame only works on recursive objects 
is.recursive(rel_mat)
is.atomic(rel_mat)
rel_mat_recursive <- as.data.frame(rel_mat)
is.recursive(rel_mat_recursive)

rel_mat_recursive_t <- t(rel_mat_recursive)
is.recursive(rel_mat_recursive_t)
rel_mat_recursive_t <- as.data.frame(rel_mat_recursive_t)

#
grouping_info <- data.frame(row.names = rownames(rel_mat_recursive_t), t(as.data.frame(strsplit(rownames(rel_mat_recursive_t),"\t"))))
head(grouping_info)

NMDS_L5 <- metaMDS(rel_mat_recursive_t, distance = "bray", k = 2, try = 20, trymax = 100)
stressplot(NMDS_L5, pch = 19, cex=0.75, l.col = "tomato", p.col = "skyblue")

info_L5 = data.frame(x=NMDS_L5$point[,2],y=NMDS_L5$point[,1],SampleID = as.factor(grouping_info[,1]))

# Merge metadata file with info_L5, which contains NMDS coordinates
L5_merged <- merge(info_L5, L5_metadata, by.x = "SampleID", by.y = "SampleID")
```

```{R eval=TRUE, echo=FALSE, collapse=TRUE, message=FALSE}
# Plot NMDS
p <- ggplot(L5_merged, aes(x, y, label="", color = Type, group = Type, text = paste("Cave: ", Cave))) +
  geom_point() +
  scale_shape_manual(values=c(1:17)) +
  geom_text() +
  ggtitle("NMDS of Family-Level Taxonomy using Silva without Filtering") +
  theme(panel.background = element_rect(fill = "white")) +
  stat_ellipse(geom = "path")

p <- ggplotly(p)

p
```
